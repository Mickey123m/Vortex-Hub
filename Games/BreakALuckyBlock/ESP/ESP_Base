local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

_G.BaseESPToggle = not _G.BaseESPToggle

if not _G.BaseESPToggle then
    local basesFolder = Workspace:FindFirstChild("Bases")
    if basesFolder then
        for _, base in pairs(basesFolder:GetChildren()) do
            for _, obj in pairs(base:GetDescendants()) do
                if obj.Name == "GlobalSquareESP" then
                    obj:Destroy()
                end
            end
        end
    end
    return
end

local function getComplexBoundingBox(object)
    if object:IsA("Model") then
        return object:GetBoundingBox()
    end

    local min = Vector3.new(math.huge, math.huge, math.huge)
    local max = Vector3.new(-math.huge, -math.huge, -math.huge)

    for _, desc in pairs(object:GetDescendants()) do
        if desc:IsA("BasePart") then
            local size = desc.Size
            local cf = desc.CFrame
            local corners = {
                cf * Vector3.new(-size.X/2, -size.Y/2, -size.Z/2),
                cf * Vector3.new(size.X/2, size.Y/2, size.Z/2),
                cf * Vector3.new(-size.X/2, -size.Y/2, size.Z/2),
                cf * Vector3.new(size.X/2, -size.Y/2, -size.Z/2),
                cf * Vector3.new(-size.X/2, size.Y/2, -size.Z/2),
                cf * Vector3.new(size.X/2, size.Y/2, -size.Z/2),
                cf * Vector3.new(size.X/2, -size.Y/2, size.Z/2),
                cf * Vector3.new(-size.X/2, size.Y/2, size.Z/2)
            }
            for _, corner in pairs(corners) do
                min = Vector3.new(math.min(min.X, corner.X), math.min(min.Y, corner.Y), math.min(min.Z, corner.Z))
                max = Vector3.new(math.max(max.X, corner.X), math.max(max.Y, corner.Y), math.max(max.Z, corner.Z))
            end
        end
    end

    if min.X == math.huge then return nil end
    local size = max - min
    local center = min + size/2
    return CFrame.new(center), size
end

local function createSquareESP(floorModel)
    if not floorModel or not _G.BaseESPToggle then return end
    
    local cf, size = getComplexBoundingBox(floorModel)
    if not cf or not size then return end

    local existing = floorModel:FindFirstChild("GlobalSquareESP")
    if existing then
        existing.CFrame = cf
        existing.Size = size + Vector3.new(1.2, 1.2, 1.2)
        return
    end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "GlobalSquareESP"
    box.Size = size + Vector3.new(1.2, 1.2, 1.2)
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Adornee = Workspace.Terrain
    box.CFrame = cf
    box.Color3 = Color3.new(1, 1, 1)
    box.Transparency = 0.65
    box.Parent = floorModel
end

local function updateBoxes()
    if not _G.BaseESPToggle then return end
    
    local basesFolder = Workspace:FindFirstChild("Bases")
    if not basesFolder then return end

    local myBase = nil
    local baseId = player:GetAttribute("Base")
    
    if baseId and basesFolder:FindFirstChild(tostring(baseId)) then
        myBase = basesFolder:FindFirstChild(tostring(baseId))
    else
        for _, b in pairs(basesFolder:GetChildren()) do
            if b.Name == player.Name or b:FindFirstChild(player.Name) then
                myBase = b
                break
            end
        end
    end

    if myBase then
        for _, obj in pairs(myBase:GetChildren()) do
            if obj.Name:find("Floor") then
                createSquareESP(obj)
            end
        end
    end
end

task.spawn(function()
    while _G.BaseESPToggle do
        pcall(updateBoxes)
        task.wait(5) 
    end
end)