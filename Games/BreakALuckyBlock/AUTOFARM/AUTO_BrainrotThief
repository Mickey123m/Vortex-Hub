local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

local function parseCashValue(text)
    if not text then return 0 end
    local cleanText = text:lower():gsub("[^%d%.km]", "")
    local value = tonumber(cleanText:match("[%d%.]+"))
    if not value then return 0 end
    if cleanText:find("k") then return value * 1000
    elseif cleanText:find("m") then return value * 1000000 end
    return value
end

local function resetSlapCooldown()
    pcall(function()
        player:SetAttribute("SlapCooldown", 0) 
    end)
end

local function getSlapHand()
    local char = player.Character
    return (char and char:FindFirstChild("Slap Hand")) or player.Backpack:FindFirstChild("Slap Hand")
end

local function isHoldingValidItem()
    local val = player:GetAttribute("Carrying")
    return (val ~= nil and tostring(val) ~= "" and tostring(val):lower() ~= "none")
end

_G.BountyHunter = true
_G.ValorAlvoBounty = _G.ValorAlvoBounty or 100

local function runThiefLogic()
    while _G.BountyHunter do
        local tool = getSlapHand()
        local brainrotsModel = Workspace:FindFirstChild("Brainrots")
        local myChar = player.Character
        local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")

        local hasPrimaryFarmTarget = false
        if brainrotsModel and _G.UltimateAutoFarm then
            for _, br in pairs(brainrotsModel:GetChildren()) do
                local cashLabel = br:FindFirstChild("CharCash", true)
                if cashLabel then
                    local value = parseCashValue(cashLabel.Text)
                    if value >= (_G.ValorMinimo or 20) then
                        hasPrimaryFarmTarget = true
                        break
                    end
                end
            end
        end

        if not hasPrimaryFarmTarget and not isHoldingValidItem() and tool and brainrotsModel and myRoot then
            for _, otherPlayer in pairs(Players:GetPlayers()) do
                if not _G.BountyHunter or isHoldingValidItem() then break end
                
                local targetChar = otherPlayer.Character
                local targetRoot = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
                
                if otherPlayer ~= player and targetRoot then
                    local targetHasBounty = false
                    
                    for _, brainrot in pairs(brainrotsModel:GetChildren()) do
                        local cashLabel = brainrot:FindFirstChild("CharCash", true)
                        if cashLabel then
                            local valor = parseCashValue(cashLabel.Text)
                            if valor >= _G.ValorAlvoBounty then
                                if (targetRoot.Position - brainrot:GetPivot().Position).Magnitude < 10 then
                                    targetHasBounty = true
                                    break
                                end
                            end
                        end
                    end

                    if targetHasBounty then
                        myRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 3)
                        
                        if tool.Parent ~= myChar then
                            tool.Parent = myChar
                        end
                        
                        resetSlapCooldown()
                        tool:Activate()
                        
                        local remote = tool:FindFirstChild("Slap") or tool:FindFirstChildOfClass("RemoteEvent")
                        if remote then
                            remote:FireServer(targetRoot)
                        end
                        task.wait(0.3)
                    end
                end
            end
        end
        task.wait(0.1)
    end
end

task.spawn(function()
    while _G.BountyHunter do
        resetSlapCooldown()
        RunService.Heartbeat:Wait()
    end
end)

task.spawn(runThiefLogic)

return function()
    _G.BountyHunter = false
end