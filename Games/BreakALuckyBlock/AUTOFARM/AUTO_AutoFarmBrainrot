local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer

local MINIMUM_VALUE = _G.ValorMinimo or 20
local WEBHOOK_URL = _G.WebhookURL or ""
local DISCORD_ID = _G.DiscordID or ""

local SKY_HEIGHT = 165 
local FLY_SPEED = 25.0

if _G.UltimateAutoFarm == nil then
    _G.UltimateAutoFarm = false
end

_G.UltimateAutoFarm = not _G.UltimateAutoFarm

if not _G.UltimateAutoFarm then 
    return 
end

player:SetAttribute("SlapCooldown", 0)

local function parseCashValue(text)
    local cleanText = text:lower():gsub("[^%d%.km]", "")
    local value = tonumber(cleanText:match("[%d%.]+"))
    if not value then return 0 end
    if cleanText:find("k") then return value * 1000
    elseif cleanText:find("m") then return value * 1000000 end
    return value
end

local function isHoldingValidItem()
    local val = player:GetAttribute("Carrying")
    return (val ~= nil and tostring(val) ~= "" and tostring(val):lower() ~= "none")
end

local function sendWebhook(itemName, itemValue, itemRarity, deliveryStatus)
    if WEBHOOK_URL == "" or not WEBHOOK_URL:find("discord") then
        return
    end
    
    local mention = ""
    if DISCORD_ID ~= "" and DISCORD_ID ~= "YOUR_ID_HERE" then
        mention = "<@" .. DISCORD_ID .. ">"
    else
        mention = "@everyone"
    end
    
    local embedColor = 0x00FF7F 
    
    if deliveryStatus:find("Failed") then
        embedColor = 0x2F3136 
    else
        local rawRarity = string.lower(itemRarity)
        if string.find(rawRarity, "rare") then embedColor = 0x00BFFF
        elseif string.find(rawRarity, "epic") then embedColor = 0x9400D3
        elseif string.find(rawRarity, "legendary") then embedColor = 0xFFD700
        elseif string.find(rawRarity, "mythic") or string.find(rawRarity, "exotic") then embedColor = 0xFF4500 end
    end

    local avatarImg = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=420&height=420&format=png"
    
    local data = {
        ["content"] = "ðŸš€ **Vortex Hub Update** " .. mention, 
        ["embeds"] = {{
            ["title"] = deliveryStatus:find("Success") and "ðŸ’° **ITEM DELIVERED**" or "âš ï¸ **DELIVERY ERROR**",
            ["color"] = embedColor,
            ["thumbnail"] = {["url"] = avatarImg},
            ["fields"] = {
                {["name"] = "ðŸ‘¤ Player", ["value"] = "```" .. player.Name .. "```", ["inline"] = true},
                {["name"] = "ðŸ“¦ Item", ["value"] = "```" .. itemName .. "```", ["inline"] = true},
                {["name"] = "ðŸ’Ž Rarity", ["value"] = "```" .. itemRarity .. "```", ["inline"] = true},
                {["name"] = "ðŸ’µ Value", ["value"] = "```" .. tostring(itemValue) .. "```", ["inline"] = true},
                {["name"] = "ðŸ“ Actual Status", ["value"] = "```" .. deliveryStatus .. "```", ["inline"] = true},
                {["name"] = "ðŸ•’ Time", ["value"] = "```Vortex Hub | " .. os.date("%X") .. "```", ["inline"] = false}
            }
        }}
    }
    
    pcall(function()
        local json = HttpService:JSONEncode(data)
        local requestFunc = (syn and syn.request) or (http and http.request) or request
        if requestFunc then
            requestFunc({
                Url = WEBHOOK_URL, Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = json
            })
        end
    end)
end

local function isAllowedCooldown(brainrot)
    local infoGui = brainrot:FindFirstChild("InfoGui", true)
    if not infoGui then return true end 
    local countdown = infoGui:FindFirstChild("Countdown", true)
    if countdown then
        local textLabel = countdown:FindFirstChild("TextLabel")
        if textLabel and textLabel.Visible and textLabel.Text ~= "" then
            local seconds = tonumber(textLabel.Text:match("%d+"))
            if seconds then return seconds > 3 end
        end
    end
    return true 
end

local function megaForcePrompt(prompt)
    if prompt and prompt:IsA("ProximityPrompt") then
        prompt.HoldDuration = 0
        prompt.Enabled = true
        if fireproximityprompt then 
            fireproximityprompt(prompt) 
        else
            prompt:InputHoldBegin()
            prompt:InputHoldEnd()
        end
    end
end

RunService.Stepped:Connect(function()
    if _G.UltimateAutoFarm and player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
        local root = player.Character:FindFirstChild("HumanoidRootPart")
        if root and isHoldingValidItem() then
            root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, 0, root.AssemblyLinearVelocity.Z)
            root.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
        end
    end
end)

task.spawn(function()
    while _G.UltimateAutoFarm do
        local character = player.Character
        local root = character and character:FindFirstChild("HumanoidRootPart")
        local brainrotsModel = Workspace:FindFirstChild("Brainrots")
        local invisWalls = Workspace:FindFirstChild("InvisWalls")
        local zoneWall = invisWalls and invisWalls:FindFirstChild("ZoneWall")
        
        if root and brainrotsModel and not isHoldingValidItem() then
            for _, brainrot in pairs(brainrotsModel:GetChildren()) do
                if not _G.UltimateAutoFarm or isHoldingValidItem() then break end
                
                local cashLabel = brainrot:FindFirstChild("CharCash", true)
                local rarityLabel = brainrot:FindFirstChild("CharRarity", true)
                local valueText = cashLabel and cashLabel.Text or "0"
                local rarityText = rarityLabel and rarityLabel.Text or "Common"
                local itemName = brainrot.Name

                local itemValue = parseCashValue(valueText)
                if itemValue >= MINIMUM_VALUE and isAllowedCooldown(brainrot) then
                    local collectPrompt = brainrot:FindFirstChildWhichIsA("ProximityPrompt", true)
                    local targetPart = brainrot:FindFirstChildWhichIsA("BasePart", true)
                    
                    if targetPart and collectPrompt then
                        root.CFrame = CFrame.new(targetPart.Position)
                        
                        local pickStart = os.clock()
                        while _G.UltimateAutoFarm and not isHoldingValidItem() and brainrot.Parent == brainrotsModel and os.clock() - pickStart < 2 do
                            megaForcePrompt(collectPrompt)
                            task.wait(0.1)
                        end
                        
                        if isHoldingValidItem() and zoneWall then
                            local wallPos = zoneWall:GetPivot().Position
                            local passedWall = false
                            local abortFlight = false
                            
                            root.CFrame = CFrame.new(root.Position.X, SKY_HEIGHT, root.Position.Z)
                            
                            local flightConn
                            flightConn = RunService.Stepped:Connect(function(_, dt)
                                if not _G.UltimateAutoFarm or passedWall or abortFlight or not root or not root.Parent then
                                    if flightConn then flightConn:Disconnect() end
                                    return
                                end

                                if not isHoldingValidItem() then
                                    abortFlight = true
                                    return
                                end

                                local targetPos = Vector3.new(wallPos.X, SKY_HEIGHT, wallPos.Z)
                                local diff = targetPos - root.Position
                                local distance = Vector2.new(diff.X, diff.Z).Magnitude
                                
                                if distance > 2 then
                                    local direction = diff.Unit
                                    local moveStep = direction * FLY_SPEED * dt
                                    root.CFrame = CFrame.new(root.Position + moveStep) * CFrame.lookAt(Vector3.new(0,0,0), direction)
                                else
                                    root.CFrame = root.CFrame * CFrame.new(0, 0, -45)
                                    passedWall = true
                                end
                            end)

                            local timeout = os.clock()
                            while _G.UltimateAutoFarm and not passedWall and not abortFlight and (os.clock() - timeout < 12) do
                                task.wait()
                            end

                            if flightConn then flightConn:Disconnect() end

                            if passedWall and not abortFlight then
                                task.wait(0.5)
                                if not isHoldingValidItem() then
                                    sendWebhook(itemName, valueText, rarityText, "Success: Item Delivered")
                                end
                            end
                        end
                        break 
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

_G.VortexStopFarm = function()
    _G.UltimateAutoFarm = false
end