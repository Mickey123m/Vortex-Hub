local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer

local MINIMUM_VALUE = _G.ValorMinimo
local WEBHOOK_URL = _G.WebhookURL or ""
local DISCORD_ID = _G.DiscordID or ""

local SKY_HEIGHT = 165 
local FLY_SPEED = 30.0
local PRIORITY_CHECK_INTERVAL = 0.1 -- Verifica brainrots a cada 0.1 segundos

if not MINIMUM_VALUE or MINIMUM_VALUE <= 0 then
    return
end

if _G.UltimateAutoFarm == nil then
    _G.UltimateAutoFarm = false
end

_G.UltimateAutoFarm = not _G.UltimateAutoFarm

if not _G.UltimateAutoFarm then 
    return 
end

player:SetAttribute("SlapCooldown", 0)

-- Vari치vel de controle para interromper a칞칫es atuais
local currentAction = {
    active = false,
    interrupt = false
}

local function parseCashValue(text)
    local cleanText = text:lower():gsub("[^%d%.km]", "")
    local value = tonumber(cleanText:match("[%d%.]+"))
    if not value then return 0 end
    if cleanText:find("k") then return value * 1000
    elseif cleanText:find("m") then return value * 1000000 end
    return value
end

local function isHoldingValidItem()
    local val = player:GetAttribute("Carrying")
    return (val ~= nil and tostring(val) ~= "" and tostring(val):lower() ~= "none")
end

local function sendWebhook(itemName, itemValue, itemRarity, deliveryStatus)
    if WEBHOOK_URL == "" or not WEBHOOK_URL:find("discord") then
        return
    end
    
    local mention = ""
    if DISCORD_ID ~= "" and DISCORD_ID ~= "YOUR_ID_HERE" then
        mention = "<@" .. DISCORD_ID .. ">"
    else
        mention = "@everyone"
    end
    
    local embedColor = 0x00FF7F 
    
    if deliveryStatus:find("Failed") then
        embedColor = 0x2F3136 
    else
        local rawRarity = string.lower(itemRarity)
        if string.find(rawRarity, "rare") then embedColor = 0x00BFFF
        elseif string.find(rawRarity, "epic") then embedColor = 0x9400D3
        elseif string.find(rawRarity, "legendary") then embedColor = 0xFFD700
        elseif string.find(rawRarity, "mythic") or string.find(rawRarity, "exotic") then embedColor = 0xFF4500 end
    end

    local avatarImg = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=420&height=420&format=png"
    
    local data = {
        ["content"] = "游 **Vortex Hub Update** " .. mention, 
        ["embeds"] = {{
            ["title"] = deliveryStatus:find("Success") and "游눯 **ITEM DELIVERED**" or "丘멆잺 **DELIVERY ERROR**",
            ["color"] = embedColor,
            ["thumbnail"] = {["url"] = avatarImg},
            ["fields"] = {
                {["name"] = "游녻 Player", ["value"] = "```" .. player.Name .. "```", ["inline"] = true},
                {["name"] = "游닍 Item", ["value"] = "```" .. itemName .. "```", ["inline"] = true},
                {["name"] = "游눑 Rarity", ["value"] = "```" .. itemRarity .. "```", ["inline"] = true},
                {["name"] = "游눳 Value", ["value"] = "```" .. tostring(itemValue) .. "```", ["inline"] = true},
                {["name"] = "游늸 Actual Status", ["value"] = "```" .. deliveryStatus .. "```", ["inline"] = true},
                {["name"] = "游 Time", ["value"] = "```Vortex Hub | " .. os.date("%X") .. "```", ["inline"] = false}
            }
        }}
    }
    
    pcall(function()
        local json = HttpService:JSONEncode(data)
        local requestFunc = (syn and syn.request) or (http and http.request) or request
        if requestFunc then
            requestFunc({
                Url = WEBHOOK_URL, Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = json
            })
        end
    end)
end

local function isAllowedCooldown(brainrot)
    local infoGui = brainrot:FindFirstChild("InfoGui", true)
    if not infoGui then return true end 
    local countdown = infoGui:FindFirstChild("Countdown", true)
    if countdown then
        local textLabel = countdown:FindFirstChild("TextLabel")
        if textLabel and textLabel.Visible and textLabel.Text ~= "" then
            local seconds = tonumber(textLabel.Text:match("%d+"))
            if seconds then return seconds > 3 end
        end
    end
    return true 
end

local function megaForcePrompt(prompt)
    if prompt and prompt:IsA("ProximityPrompt") then
        prompt.HoldDuration = 0
        prompt.Enabled = true
        if fireproximityprompt then fireproximityprompt(prompt) else
            prompt:InputHoldBegin()
            prompt:InputHoldEnd()
        end
    end
end

-- Fun칞칚o para verificar se existe brainrot v치lido dispon칤vel
local function checkForValidBrainrot()
    local brainrotsModel = Workspace:FindFirstChild("Brainrots")
    if not brainrotsModel then return nil end
    
    for _, brainrot in pairs(brainrotsModel:GetChildren()) do
        local cashLabel = brainrot:FindFirstChild("CharCash", true)
        local rarityLabel = brainrot:FindFirstChild("CharRarity", true)
        local valueText = cashLabel and cashLabel.Text or "0"
        local rarityText = rarityLabel and rarityLabel.Text or "Common"
        
        local itemValue = parseCashValue(valueText)
        if itemValue >= MINIMUM_VALUE and isAllowedCooldown(brainrot) then
            return {
                brainrot = brainrot,
                name = brainrot.Name,
                value = itemValue,
                valueText = valueText,
                rarity = rarityText
            }
        end
    end
    return nil
end

-- Sistema de interrup칞칚o for칞ada de qualquer a칞칚o
local function forceInterruptCurrentActions()
    currentAction.interrupt = true
    
    -- Cancela qualquer anima칞칚o em execu칞칚o
    local character = player.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
                track:Stop()
            end
        end
    end
end

RunService.Stepped:Connect(function()
    if _G.UltimateAutoFarm and player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
        local root = player.Character:FindFirstChild("HumanoidRootPart")
        if root and isHoldingValidItem() then
            root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, 0, root.AssemblyLinearVelocity.Z)
            root.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
        end
    end
end)

-- Thread de monitoramento cont칤nuo com PRIORIDADE M츼XIMA
task.spawn(function()
    while _G.UltimateAutoFarm do
        -- Verifica se existe brainrot v치lido dispon칤vel
        if not isHoldingValidItem() then
            local validBrainrot = checkForValidBrainrot()
            
            if validBrainrot then
                -- INTERROMPE QUALQUER A칂츾O ATUAL IMEDIATAMENTE
                forceInterruptCurrentActions()
                
                -- Marca que uma a칞칚o priorit치ria est치 ativa
                currentAction.active = true
                currentAction.interrupt = false
                
                -- Executa a coleta do brainrot
                task.spawn(function()
                    local character = player.Character
                    local root = character and character:FindFirstChild("HumanoidRootPart")
                    local invisWalls = Workspace:FindFirstChild("InvisWalls")
                    local zoneWall = invisWalls and invisWalls:FindFirstChild("ZoneWall")
                    
                    if not root then 
                        currentAction.active = false
                        return 
                    end
                    
                    local brainrot = validBrainrot.brainrot
                    local collectPrompt = brainrot:FindFirstChildWhichIsA("ProximityPrompt", true)
                    local targetPart = brainrot:FindFirstChildWhichIsA("BasePart", true)
                    
                    if targetPart and collectPrompt then
                        -- Teleporta instantaneamente para o brainrot
                        root.CFrame = CFrame.new(targetPart.Position)
                        task.wait(0.1)
                        
                        -- Tenta coletar o item
                        local pickStart = os.clock()
                        while _G.UltimateAutoFarm and not isHoldingValidItem() and brainrot.Parent and os.clock() - pickStart < 3 do
                            megaForcePrompt(collectPrompt)
                            task.wait(0.1)
                        end
                        
                        -- Se coletou o item, vai entregar
                        if isHoldingValidItem() and zoneWall then
                            local wallPos = zoneWall:GetPivot().Position
                            local passedWall = false
                            
                            root.CFrame = CFrame.new(root.Position.X, SKY_HEIGHT, root.Position.Z)
                            
                            local connection
                            connection = RunService.Stepped:Connect(function(_, dt)
                                if not _G.UltimateAutoFarm or passedWall or not root or not root.Parent then
                                    if connection then connection:Disconnect() end
                                    return
                                end

                                local targetPos = Vector3.new(wallPos.X, SKY_HEIGHT, wallPos.Z)
                                local diff = targetPos - root.Position
                                local distance = Vector2.new(diff.X, diff.Z).Magnitude
                                
                                if distance > 2 then
                                    local direction = diff.Unit
                                    local moveStep = direction * FLY_SPEED * dt
                                    root.CFrame = CFrame.new(root.Position + moveStep) * CFrame.lookAt(Vector3.new(0,0,0), direction)
                                else
                                    root.CFrame = root.CFrame * CFrame.new(0, 0, -45)
                                    passedWall = true
                                end
                            end)

                            local timeout = os.clock()
                            repeat task.wait() until passedWall or not _G.UltimateAutoFarm or (os.clock() - timeout > 10)

                            if passedWall then
                                task.wait(0.8)
                                if not isHoldingValidItem() then
                                    sendWebhook(validBrainrot.name, validBrainrot.valueText, validBrainrot.rarity, "Success: Item Delivered")
                                else
                                    sendWebhook(validBrainrot.name, validBrainrot.valueText, validBrainrot.rarity, "Failed: Item stuck in hand")
                                end
                            elseif os.clock() - timeout > 10 then
                                sendWebhook(validBrainrot.name, validBrainrot.valueText, validBrainrot.rarity, "Failed: Flight time exceeded")
                            end
                        end
                    end
                    
                    currentAction.active = false
                end)
            end
        end
        
        -- Intervalo de verifica칞칚o muito curto para m치xima responsividade
        task.wait(PRIORITY_CHECK_INTERVAL)
    end
end)

_G.VortexStopFarm = function()
    _G.UltimateAutoFarm = false
    currentAction.active = false
    currentAction.interrupt = false
end