local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

_G.ESP_Enabled = true
_G.ESP_Connections = _G.ESP_Connections or {}

local function applyFullESP(player)
    if player == LocalPlayer then return end

    local function onCharacterAdded(character)
        if not _G.ESP_Enabled then return end

        -- Tenta pegar o root part, se falhar o script não trava
        local root = character:WaitForChild("HumanoidRootPart", 15)
        if not root then return end

        -- Remove ESP antigo para evitar duplicatas
        local existing = character:FindFirstChild("FullPlayerESP")
        if existing then existing:Destroy() end

        local billboard = Instance.new("BillboardGui")
        billboard.Name = "FullPlayerESP"
        billboard.Adornee = root
        billboard.Parent = character
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffsetWorldSpace = Vector3.new(0, 3.5, 0)
        billboard.AlwaysOnTop = true
        billboard.ResetOnSpawn = false

        local textLabel = Instance.new("TextLabel")
        textLabel.Parent = billboard
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.TextColor3 = Color3.fromRGB(255, 0, 4) 
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = 14
        textLabel.TextXAlignment = Enum.TextXAlignment.Center
        textLabel.TextYAlignment = Enum.TextYAlignment.Center
        textLabel.Text = player.Name -- Define o nome imediatamente para evitar "Label"

        local connection
        connection = RunService.RenderStepped:Connect(function()
            if not _G.ESP_Enabled then
                if billboard then billboard:Destroy() end
                connection:Disconnect()
                return
            end

            if character and character.Parent and root and root.Parent then
                local myChar = LocalPlayer.Character
                local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
                
                if myRoot then
                    local dist = (myRoot.Position - root.Position).Magnitude
                    textLabel.Text = player.Name .. "\n[" .. math.floor(dist) .. "m]"
                else
                    -- Mesmo sem o seu Root, mantém o nome visível
                    textLabel.Text = player.Name
                end
            else
                connection:Disconnect()
            end
        end)
    end

    -- Conecta o evento e armazena
    local charAddedConn = player.CharacterAdded:Connect(onCharacterAdded)
    table.insert(_G.ESP_Connections, charAddedConn)

    -- Se o personagem já existir, aplica imediatamente
    if player.Character then 
        task.spawn(onCharacterAdded, player.Character) 
    end
end

-- Limpa conexões antigas antes de iniciar (evita bugs de re-execução)
if _G.ESP_Connections then
    for _, v in pairs(_G.ESP_Connections) do v:Disconnect() end
    _G.ESP_Connections = {}
end

-- Inicia para quem já está no servidor
for _, player in pairs(Players:GetPlayers()) do 
    applyFullESP(player) 
end

-- Escuta novos jogadores
local playerAddedConn = Players.PlayerAdded:Connect(applyFullESP)
table.insert(_G.ESP_Connections, playerAddedConn)

print("[ESP] ATIVADO COM CORREÇÕES")