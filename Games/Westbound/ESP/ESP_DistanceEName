local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local function applyFullESP(player)
    -- Não aplica em você mesmo
    if player == LocalPlayer then return end

    local function onCharacterAdded(character)
        -- Aguarda a parte principal do corpo
        local root = character:WaitForChild("HumanoidRootPart", 10)
        if not root then return end

        -- Limpa ESP anterior
        if character:FindFirstChild("FullPlayerESP") then 
            character.FullPlayerESP:Destroy() 
        end

        -- --- CRIAÇÃO DA INTERFACE ---
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "FullPlayerESP"
        billboard.Adornee = root
        billboard.Parent = character
        billboard.Size = UDim2.new(0, 200, 0, 50)
        -- Offset fixo no mundo para não ficar torto
        billboard.StudsOffsetWorldSpace = Vector3.new(0, 3.5, 0)
        billboard.AlwaysOnTop = true
        billboard.ResetOnSpawn = false

        local textLabel = Instance.new("TextLabel")
        textLabel.Parent = billboard
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Text = "" -- Será preenchido pelo loop
        textLabel.TextColor3 = Color3.fromRGB(255, 0, 4) -- Vermelho
        textLabel.TextStrokeTransparency = 1 -- Sem bordas
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = 14
        textLabel.TextXAlignment = Enum.TextXAlignment.Center
        textLabel.TextYAlignment = Enum.TextYAlignment.Center

        -- Loop de atualização da distância e nome
        local connection
        connection = RunService.RenderStepped:Connect(function()
            if character and character.Parent and root and root.Parent then
                local myChar = LocalPlayer.Character
                local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
                if myRoot then
                    local dist = (myRoot.Position - root.Position).Magnitude
                    -- FORMATO: Nome na linha 1 e [Distância] na linha 2
                    textLabel.Text = player.Name .. "\n[" .. math.floor(dist) .. "m]"
                end
            else
                -- Desconecta se o personagem sumir
                connection:Disconnect()
            end
        end)
    end

    if player.Character then 
        task.spawn(onCharacterAdded, player.Character) 
    end
    player.CharacterAdded:Connect(onCharacterAdded)
end

-- Inicializa para todos
for _, player in pairs(Players:GetPlayers()) do 
    applyFullESP(player) 
end

-- Monitora novos jogadores
Players.PlayerAdded:Connect(applyFullESP)