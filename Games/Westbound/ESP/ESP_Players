-- SERVIÇOS
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- CONFIG
local ESP_COLOR = Color3.fromRGB(255, 0, 0)
local OUTLINE_COLOR = Color3.fromRGB(255, 255, 255)

shared.PlayerESP_Enabled = true

-- Cria ou garante Highlight no personagem
local function EnsureHighlight(player)
	if not shared.PlayerESP_Enabled then return end
	if player == LocalPlayer then return end

	local character = player.Character
	if not character then return end

	-- Se algum script apagar, recria
	local highlight = character:FindFirstChild("ESP_Highlight")
	if not highlight then
		highlight = Instance.new("Highlight")
		highlight.Name = "ESP_Highlight"
		highlight.Parent = character
	end

	highlight.Adornee = character
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Enabled = true
	highlight.FillColor = ESP_COLOR
	highlight.OutlineColor = OUTLINE_COLOR
	highlight.FillTransparency = 0.5
	highlight.OutlineTransparency = 0
end

-- Quando o personagem carregar
local function SetupPlayer(player)
	if player == LocalPlayer then return end

	-- Garante quando spawnar
	player.CharacterAdded:Connect(function(character)
		-- Espera qualquer parte válida
		character:WaitForChild("HumanoidRootPart", 10)
		task.wait(0.1)
		EnsureHighlight(player)
	end)
end

-- Jogadores atuais
for _, player in ipairs(Players:GetPlayers()) do
	SetupPlayer(player)
end

-- Novos jogadores
Players.PlayerAdded:Connect(SetupPlayer)

-- LOOP DE GARANTIA (ANTI-FALHA)
RunService.Heartbeat:Connect(function()
	if not shared.PlayerESP_Enabled then return end

	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			EnsureHighlight(player)
		end
	end
end)

print("[PLAYER ESP] ATIVO - 100% ROBUSTO")
