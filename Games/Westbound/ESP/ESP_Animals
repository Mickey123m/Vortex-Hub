-- ESP de Animais com Suporte a Remoção
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local OutlineColor = Color3.fromRGB(255, 255, 0)
local MaxDistance = 999999
local ShowName = true
local ShowDistance = true

shared.AnimalESP_Data = shared.AnimalESP_Data or {ActiveESP = {}, Connections = {}}

local function GetAnimalName(fullName)
    return fullName:match("^(.-)%{") or fullName
end

local function GetModelPart(model)
    return model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Torso") or model:FindFirstChild("Head") or model:FindFirstChildWhichIsA("BasePart")
end

local function CreateESP(model)
    if shared.AnimalESP_Data.ActiveESP[model] then return end
    local mainPart = GetModelPart(model)
    if not mainPart then return end
    
    shared.AnimalESP_Data.ActiveESP[model] = {}
    local highlight = Instance.new("Highlight")
    highlight.Name = "AnimalHighlight"
    highlight.Adornee = model
    highlight.FillColor = OutlineColor
    highlight.FillTransparency = 0.5
    highlight.OutlineColor = OutlineColor
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = model
    shared.AnimalESP_Data.ActiveESP[model].Highlight = highlight
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "AnimalESP"
    billboard.Adornee = mainPart
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = mainPart
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = OutlineColor
    textLabel.TextSize = 16
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.Parent = billboard
    shared.AnimalESP_Data.ActiveESP[model].Billboard = billboard
    shared.AnimalESP_Data.ActiveESP[model].TextLabel = textLabel
end

local function RemoveESP(model)
    if shared.AnimalESP_Data.ActiveESP[model] then
        if shared.AnimalESP_Data.ActiveESP[model].Highlight then shared.AnimalESP_Data.ActiveESP[model].Highlight:Destroy() end
        if shared.AnimalESP_Data.ActiveESP[model].Billboard then shared.AnimalESP_Data.ActiveESP[model].Billboard:Destroy() end
        shared.AnimalESP_Data.ActiveESP[model] = nil
    end
end

-- Salvar conexões para poder matar depois
table.insert(shared.AnimalESP_Data.Connections, RunService.RenderStepped:Connect(function()
    if not Workspace:FindFirstChild("Animals") then return end
    for _, animal in pairs(Workspace.Animals:GetChildren()) do
        if animal:IsA("Model") then
            local mainPart = GetModelPart(animal)
            if mainPart then
                local dist = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) and (LocalPlayer.Character.HumanoidRootPart.Position - mainPart.Position).Magnitude or 0
                if dist <= MaxDistance then
                    if not shared.AnimalESP_Data.ActiveESP[animal] then CreateESP(animal) end
                    if shared.AnimalESP_Data.ActiveESP[animal] and shared.AnimalESP_Data.ActiveESP[animal].TextLabel then
                        local text = (ShowName and GetAnimalName(animal.Name) or "") .. (ShowDistance and "\n[" .. math.floor(dist) .. "m]" or "")
                        shared.AnimalESP_Data.ActiveESP[animal].TextLabel.Text = text
                    end
                else
                    RemoveESP(animal)
                end
            end
        end
    end
end))