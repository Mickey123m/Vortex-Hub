local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local RobEvent = ReplicatedStorage.GeneralEvents.Rob

-- Limpeza de segurança
if _G.RobConnection then _G.RobConnection:Disconnect() end
if _G.CharAddedConn then _G.CharAddedConn:Disconnect() end

_G.AutoRobActive = true
local playerCooldowns = {} 

-- CONFIGURAÇÕES DE TEMPO (Para não bugar o F)
local WORK_TIME = 5     -- Tempo que fica roubando (segundos)
local REST_TIME = 2     -- Tempo que fica desligado para o "F" desbugar
local TIME_BETWEEN_ROBS = 15 

local ContextMain, hrp
local isResting = false

local function updateReferences(char)
    if not char then return end
    hrp = char:WaitForChild("HumanoidRootPart", 10)
    local contextActions = char:WaitForChild("ContextActions", 10)
    local contextMainModule = contextActions and contextActions:WaitForChild("ContextMain", 10)
    
    if contextMainModule then
        local success, module = pcall(require, contextMainModule)
        if success then ContextMain = module end
    end
end

local function instantClick()
    if ContextMain and ContextMain.ResetContextHoldGui then
        ContextMain:ResetContextHoldGui(true)
    end
end

-- Lógica de Ciclo (Alterna entre trabalhando e descansando)
task.spawn(function()
    while _G.AutoRobActive do
        isResting = false
        -- print("Aura de Roubo: Ativa")
        task.wait(WORK_TIME)
        
        isResting = true
        -- print("Aura de Roubo: Descansando (Limpando Interações)")
        if ContextMain and ContextMain.ResetContextHoldGui then
            ContextMain:ResetContextHoldGui(false) -- Libera o F
        end
        task.wait(REST_TIME)
    end
end)

local function runRobCycle()
    if not _G.AutoRobActive or not hrp or not ContextMain or isResting then return end

    -- Distâncias
    local AURA_DISTANCE = 50
    local PLAYER_DISTANCE = 10

    local currentPos = hrp.Position

    -- Roubo de Registradoras
    if ContextMain.CashRegisters then
        for _, reg in pairs(ContextMain.CashRegisters) do
            if reg.Part and reg.ActiveValue and reg.ActiveValue.Value and (reg.Part.Position - currentPos).Magnitude <= AURA_DISTANCE then
                instantClick()
                RobEvent:FireServer("Register", reg)
            end
        end
    end

    -- Roubo de Cofres
    if ContextMain.Safes then
        for _, safe in pairs(ContextMain.Safes) do
            if safe.Safe and not safe.Active and (safe.Safe.Position - currentPos).Magnitude <= AURA_DISTANCE then
                instantClick()
                RobEvent:FireServer("Safe", safe)
            end
        end
    end

    -- Roubo de Players
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if not player:IsFriendsWith(plr.UserId) then
                local targetHrp = plr.Character.HumanoidRootPart
                if (targetHrp.Position - currentPos).Magnitude <= PLAYER_DISTANCE then
                    local hum = plr.Character:FindFirstChild("Humanoid")
                    if hum and hum.Health > 0 then
                        local lastRob = playerCooldowns[plr.UserId] or 0
                        if (tick() - lastRob) >= TIME_BETWEEN_ROBS then
                            instantClick()
                            RobEvent:FireServer("Player", plr)
                            playerCooldowns[plr.UserId] = tick()
                        end
                    end
                end
            end
        end
    end
end

updateReferences(player.Character)

_G.CharAddedConn = player.CharacterAdded:Connect(function(newChar)
    task.wait(1)
    updateReferences(newChar)
end)

_G.RobConnection = RunService.Heartbeat:Connect(function()
    runRobCycle()
end)

print("✅ AUTO-ROUBO COM CICLO DE DESCANSO ATIVADO")