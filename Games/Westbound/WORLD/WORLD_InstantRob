local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local RobEvent = ReplicatedStorage.GeneralEvents.Rob

-- Limpeza de seguran칞a para n칚o acumular loops
if _G.RobConnection then _G.RobConnection:Disconnect() end
if _G.CharAddedConn then _G.CharAddedConn:Disconnect() end

_G.AutoRobActive = true
local playerCooldowns = {} 

-- CONFIGURA칂칏ES
local WORK_TIME = 6      -- Tempo roubando
local REST_TIME = 1.5    -- Tempo de descanso para desbugar o F
local AURA_DISTANCE = 50 
local PLAYER_DISTANCE = 12 

local ContextMain, hrp
local isResting = false

-- Fun칞칚o para verificar invent치rio
local function isInventoryFull()
    local playerGui = player:FindFirstChild("PlayerGui")
    if playerGui then
        local inventoryGui = playerGui:FindFirstChild("MainGui") or playerGui:FindFirstChild("HUD")
        if inventoryGui then
            local inventoryBar = inventoryGui:FindFirstChild("InventoryBar", true) or inventoryGui:FindFirstChild("WeightBar", true)
            if inventoryBar and inventoryBar:IsA("Frame") then
                local fill = inventoryBar:FindFirstChild("Fill", true)
                if fill and fill.Size.X.Scale >= 0.98 then 
                    return true 
                end
            end
        end
    end
    return false
end

local function updateReferences(char)
    if not char then return end
    hrp = char:WaitForChild("HumanoidRootPart", 10)
    local contextActions = char:WaitForChild("ContextActions", 10)
    local contextMainModule = contextActions and contextActions:WaitForChild("ContextMain", 10)
    
    if contextMainModule then
        local success, module = pcall(require, contextMainModule)
        if success then ContextMain = module end
    end
end

local function instantClick()
    if ContextMain and ContextMain.ResetContextHoldGui then
        ContextMain:ResetContextHoldGui(true)
    end
end

-- Ciclo de Vida (Altern칙ncia entre roubo e descanso)
task.spawn(function()
    while _G.AutoRobActive do
        isResting = false
        task.wait(WORK_TIME)
        isResting = true
        if ContextMain and ContextMain.ResetContextHoldGui then
            ContextMain:ResetContextHoldGui(false) -- Libera o sistema de intera칞칚o
        end
        task.wait(REST_TIME)
    end
end)

local function runRobCycle()
    -- Verifica se o script est치 ativo, se n칚o est치 descansando e se h치 refer칡ncias
    if not _G.AutoRobActive or not hrp or not ContextMain or isResting then return end
    
    -- Se o invent치rio estiver cheio, para de enviar pacotes
    if isInventoryFull() then return end

    local currentPos = hrp.Position

    -- Roubo de Registradoras (Loop de Frame)
    if ContextMain.CashRegisters then
        for _, reg in pairs(ContextMain.CashRegisters) do
            if reg.Part and reg.ActiveValue and reg.ActiveValue.Value then
                if (reg.Part.Position - currentPos).Magnitude <= AURA_DISTANCE then
                    instantClick()
                    RobEvent:FireServer("Register", reg)
                end
            end
        end
    end

    -- Roubo de Cofres (Loop de Frame)
    if ContextMain.Safes then
        for _, safe in pairs(ContextMain.Safes) do
            if safe.Safe and not safe.Active then
                if (safe.Safe.Position - currentPos).Magnitude <= AURA_DISTANCE then
                    instantClick()
                    RobEvent:FireServer("Safe", safe)
                end
            end
        end
    end

    -- Roubo de Players (Loop de Frame)
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if not player:IsFriendsWith(plr.UserId) then
                local targetHrp = plr.Character.HumanoidRootPart
                if (targetHrp.Position - currentPos).Magnitude <= PLAYER_DISTANCE then
                    local hum = plr.Character:FindFirstChild("Humanoid")
                    if hum and hum.Health > 0 then
                        local lastRob = playerCooldowns[plr.UserId] or 0
                        if (tick() - lastRob) >= 15 then
                            instantClick()
                            RobEvent:FireServer("Player", plr)
                            playerCooldowns[plr.UserId] = tick()
                        end
                    end
                end
            end
        end
    end
end

updateReferences(player.Character)

_G.CharAddedConn = player.CharacterAdded:Connect(function(newChar)
    task.wait(1.5)
    updateReferences(newChar)
end)

-- Conectado ao Heartbeat (Roda a cada frame do motor f칤sico)
_G.RobConnection = RunService.Heartbeat:Connect(runRobCycle)

print("游 AUTO-ROUBO ULTRA R츼PIDO ATIVADO")