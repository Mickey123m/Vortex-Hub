local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local RobEvent = ReplicatedStorage.GeneralEvents.Rob

-- Limpeza de seguranÃ§a para evitar duplicatas
if _G.RobConnection then _G.RobConnection:Disconnect() end
if _G.CharAddedConn then _G.CharAddedConn:Disconnect() end
_G.AutoRobActive = true

local playerCooldowns = {} 

-- CONFIGURAÃ‡Ã•ES
local WORK_TIME = 8      
local REST_TIME = 1.2    
local AURA_DISTANCE = 50 
local PLAYER_DISTANCE = 12 

-- Tabela de limites de bolsa permitidos
local BAG_LIMITS = {40, 50, 60, 70, 80, 90, 100}

local ContextMain, hrp, statesFolder
local isResting = false

-- FunÃ§Ã£o de VerificaÃ§Ã£o Corrigida (Pega a referÃªncia atualizada sempre)
local function isBagFull()
    -- Tenta encontrar a pasta States novamente caso tenha sumido apÃ³s reset
    statesFolder = player:FindFirstChild("States")
    if statesFolder then
        local bagValue = statesFolder:FindFirstChild("Bag")
        if bagValue and bagValue:IsA("ValueBase") then
            local currentAmount = bagValue.Value
            
            for _, limit in ipairs(BAG_LIMITS) do
                if currentAmount >= limit then -- Mudado para >= para evitar bugs de valores acima do limite
                    return true
                end
            end
        end
    end
    return false
end

local function updateReferences(char)
    if not char then return end
    hrp = char:WaitForChild("HumanoidRootPart", 10)
    statesFolder = player:WaitForChild("States", 10)
    
    local contextActions = char:WaitForChild("ContextActions", 10)
    local contextMainModule = contextActions and contextActions:WaitForChild("ContextMain", 10)
    
    if contextMainModule then
        local success, module = pcall(require, contextMainModule)
        if success then 
            ContextMain = module 
        end
    end
end

local function instantClick()
    if ContextMain and ContextMain.ResetContextHoldGui then
        ContextMain:ResetContextHoldGui(true)
    end
end

-- Ciclo de Vida (Descanso do F) - Corrigido para verificar a flag interna
task.spawn(function()
    while true do
        if _G.AutoRobActive then
            isResting = false
            task.wait(WORK_TIME)
            if _G.AutoRobActive then -- Checa novamente apÃ³s o wait
                isResting = true
                if ContextMain and ContextMain.ResetContextHoldGui then
                    ContextMain:ResetContextHoldGui(false)
                end
                task.wait(REST_TIME)
            end
        else
            task.wait(1) -- Espera em idle se o script estiver desligado
        end
    end
end)

local function runRobCycle()
    if not _G.AutoRobActive or not hrp or not ContextMain or isResting then return end
    
    -- VerificaÃ§Ã£o de Bag (Sempre checa o valor atual)
    if isBagFull() then return end

    local currentPos = hrp.Position

    -- Registradoras
    if ContextMain.CashRegisters then
        for _, reg in pairs(ContextMain.CashRegisters) do
            if reg.Part and reg.ActiveValue and reg.ActiveValue.Value then
                if (reg.Part.Position - currentPos).Magnitude <= AURA_DISTANCE then
                    instantClick()
                    RobEvent:FireServer("Register", reg)
                end
            end
        end
    end

    -- Cofres
    if ContextMain.Safes then
        for _, safe in pairs(ContextMain.Safes) do
            if safe.Safe and not safe.Active then
                if (safe.Safe.Position - currentPos).Magnitude <= AURA_DISTANCE then
                    instantClick()
                    RobEvent:FireServer("Safe", safe)
                end
            end
        end
    end

    -- Players
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if not player:IsFriendsWith(plr.UserId) then
                local targetHrp = plr.Character.HumanoidRootPart
                if (targetHrp.Position - currentPos).Magnitude <= PLAYER_DISTANCE then
                    local hum = plr.Character:FindFirstChild("Humanoid")
                    if hum and hum.Health > 0 then
                        local lastRob = playerCooldowns[plr.UserId] or 0
                        if (tick() - lastRob) >= 15 then
                            instantClick()
                            RobEvent:FireServer("Player", plr)
                            playerCooldowns[plr.UserId] = tick()
                        end
                    end
                end
            end
        end
    end
end

-- InicializaÃ§Ã£o
if player.Character then
    updateReferences(player.Character)
end

_G.CharAddedConn = player.CharacterAdded:Connect(function(newChar)
    task.wait(1)
    updateReferences(newChar)
end)

_G.RobConnection = RunService.Heartbeat:Connect(runRobCycle)

print("ðŸš€ AUTO-ROUBO: Ativo e corrigido")