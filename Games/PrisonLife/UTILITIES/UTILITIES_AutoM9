-- Auto M9 for Prison Life
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local isActive = false
local checkInterval = 1 -- segundos

local function HasM9()
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local character = LocalPlayer.Character
    
    local found = false
    if backpack then
        for _, item in pairs(backpack:GetChildren()) do
            if string.find(item.Name:lower(), "m9") then found = true break end
        end
    end
    if character and not found then
        for _, item in pairs(character:GetChildren()) do
            if string.find(item.Name:lower(), "m9") then found = true break end
        end
    end
    
    return found
end

local function FindAndPickupM9()
    if HasM9() then return false end
    
    local foundM9 = nil
    
    -- Busca na pasta de givers do Prison Life
    local prisonItems = workspace:FindFirstChild("Prison_ITEMS")
    local giverFolder = prisonItems and prisonItems:FindFirstChild("giver")
    
    if giverFolder then
        foundM9 = giverFolder:FindFirstChild("M9")
        if not foundM9 then
            for _, item in pairs(giverFolder:GetChildren()) do
                if string.find(item.Name:lower(), "m9") then
                    foundM9 = item
                    break
                end
            end
        end
    end

    if foundM9 then
        local char = LocalPlayer.Character
        local humanoidRootPart = char and char:FindFirstChild("HumanoidRootPart")
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        
        if humanoidRootPart and humanoid then
            print("[Prison Life] M9 detectada! Teleportando...")
            
            local originalPosition = humanoidRootPart.CFrame
            
            -- Configurações de física para evitar tropeços
            humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
            humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
            
            -- CÁLCULO DE POSIÇÃO (10 de altura, 4 para trás da tela)
            local itemPos = foundM9:GetPivot().Position
            local camDirection = (Camera.CFrame.Position - itemPos).Unit
            local finalPos = itemPos + Vector3.new(0, 10, 0) + (camDirection * 4)
            
            char:PivotTo(CFrame.new(finalPos, itemPos))
            
            -- Loop de coleta via Remote
            task.spawn(function()
                local remote = workspace:FindFirstChild("Remote") and workspace.Remote:FindFirstChild("ItemHandler")
                for i = 1, 15 do
                    if remote then
                        remote:InvokeServer(foundM9)
                    end
                    task.wait(0.05)
                end
            end)
            
            ---------------------------------------------------------
            -- TEMPO DE PERMANÊNCIA (2 segundos antes de voltar)
            ---------------------------------------------------------
            task.wait(2.0)
            
            -- Retorno rápido para a posição original
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
            char:PivotTo(originalPosition)
            humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
            
            return true
        end
    end
    return false
end

local function ToggleAutoM9(state)
    isActive = state
    
    if state then
        print("[Prison Life] Auto M9: ATIVADO")
        task.spawn(function()
            while isActive do
                if not HasM9() then
                    FindAndPickupM9()
                end
                task.wait(checkInterval)
            end
        end)
        return "Auto M9: ON"
    else
        print("[Prison Life] Auto M9: DESATIVADO")
        return "Auto M9: OFF"
    end
end

-- Ativa automaticamente ao executar
ToggleAutoM9(true)

return ToggleAutoM9