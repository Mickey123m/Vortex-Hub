-- ESP PRISIONEIROS - ATIVAR
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Garantir que a estrutura global existe
if not _G.VortexHub then _G.VortexHub = {} end
if not _G.VortexHub.ESP then _G.VortexHub.ESP = {} end

if not _G.VortexHub.ESP.Inmate then
    _G.VortexHub.ESP.Inmate = {
        Active = true,
        Highlights = {},
        Connections = {}
    }
else
    -- Se já existe, apenas ativar
    _G.VortexHub.ESP.Inmate.Active = true
end

local ESP = _G.VortexHub.ESP.Inmate

local function IsInmate(player)
    return player.Team and player.Team.Name == "Inmates"
end

local function CreateHighlight(player, character)
    if not character then return end
    
    -- Remover highlight antigo se existir
    if ESP.Highlights[player] then
        pcall(function() ESP.Highlights[player]:Destroy() end)
        ESP.Highlights[player] = nil
    end
    
    if IsInmate(player) then
        local highlight = Instance.new("Highlight")
        highlight.Name = "Vortex_ESP_Inmate_" .. player.UserId
        highlight.Adornee = character
        highlight.FillColor = Color3.fromRGB(255, 105, 180)
        highlight.OutlineColor = Color3.new(1, 1, 1)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Enabled = ESP.Active
        
        highlight.Parent = character
        ESP.Highlights[player] = highlight
    end
end

local function SetupPlayer(player)
    if player == LocalPlayer then return end
    
    local function HandleCharacter(character)
        task.wait(0.5)
        CreateHighlight(player, character)
        
        local humanoid = character:WaitForChild("Humanoid", 2)
        if humanoid then
            local deathConn = humanoid.Died:Connect(function()
                if ESP.Highlights[player] then
                    ESP.Highlights[player]:Destroy()
                    ESP.Highlights[player] = nil
                end
            end)
            table.insert(ESP.Connections, deathConn)
        end
    end
    
    if player.Character then
        task.spawn(HandleCharacter, player.Character)
    end
    
    local charConn = player.CharacterAdded:Connect(HandleCharacter)
    table.insert(ESP.Connections, charConn)
    
    local teamConn = player:GetPropertyChangedSignal("Team"):Connect(function()
        if ESP.Highlights[player] then
            ESP.Highlights[player]:Destroy()
            ESP.Highlights[player] = nil
        end
        task.wait(0.1)
        if player.Character then
            CreateHighlight(player, player.Character)
        end
    end)
    table.insert(ESP.Connections, teamConn)
    
    local leavingConn = player.AncestryChanged:Connect(function(_, parent)
        if not parent and ESP.Highlights[player] then
            ESP.Highlights[player]:Destroy()
            ESP.Highlights[player] = nil
        end
    end)
    table.insert(ESP.Connections, leavingConn)
end

local function Initialize()
    -- Limpar conexões antigas
    for _, conn in pairs(ESP.Connections) do
        if conn then
            pcall(function() conn:Disconnect() end)
        end
    end
    ESP.Connections = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        task.spawn(SetupPlayer, player)
    end
    
    local playerAdded = Players.PlayerAdded:Connect(function(player)
        task.wait(1)
        SetupPlayer(player)
    end)
    table.insert(ESP.Connections, playerAdded)
    
    local playerRemoving = Players.PlayerRemoving:Connect(function(player)
        if ESP.Highlights[player] then
            ESP.Highlights[player]:Destroy()
            ESP.Highlights[player] = nil
        end
    end)
    table.insert(ESP.Connections, playerRemoving)
end

Initialize()
print("[Vortex Hub] ESP Prisioneiros ativado!")