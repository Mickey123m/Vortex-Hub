local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

if _G.DynamicESP_Active then
	_G.DynamicESP_Active = false
	
	if _G.DynamicESPLoop then
		_G.DynamicESPLoop:Disconnect()
		_G.DynamicESPLoop = nil
	end
	
	if _G.DynamicAddedConn then
		_G.DynamicAddedConn:Disconnect()
		_G.DynamicAddedConn = nil
	end

	for _, player in pairs(Players:GetPlayers()) do
		local character = player.Character
		if character then
			local highlight = character:FindFirstChild("DynamicSurvivorHighlight")
			if highlight then
				highlight:Destroy()
			end
		end
	end

	local folder = CoreGui:FindFirstChild("DynamicESP_Folder")
	if folder then
		folder:Destroy()
	end
	
	return
end

_G.DynamicESP_Active = true

local function GetESPColor()
	local localPlayer = Players.LocalPlayer
	if localPlayer:GetAttribute("Role") == "Monster" then
		return Color3.new(1, 1, 1)
	else
		return Color3.new(0, 1, 0)
	end
end

local function ManageHighlight(player)
	if player == Players.LocalPlayer then return end

	local function Update()
		if not _G.DynamicESP_Active then return end
		
		local character = player.Character
		if not character then return end

		if player:GetAttribute("Role") == "Survivor" then
			local highlight = character:FindFirstChild("DynamicSurvivorHighlight")
			if not highlight then
				highlight = Instance.new("Highlight")
				highlight.Name = "DynamicSurvivorHighlight"
				highlight.Parent = character
				highlight.Adornee = character
				highlight.FillTransparency = 0.5
				highlight.OutlineTransparency = 0
			end
			
			local color = GetESPColor()
			highlight.FillColor = color
			highlight.OutlineColor = color
		else
			local highlight = character:FindFirstChild("DynamicSurvivorHighlight")
			if highlight then
				highlight:Destroy()
			end
		end
	end

	player.CharacterAdded:Connect(Update)
	player:GetAttributeChangedSignal("Role"):Connect(Update)
	Players.LocalPlayer:GetAttributeChangedSignal("Role"):Connect(Update)
	
	if player.Character then
		Update()
	end
end

for _, player in pairs(Players:GetPlayers()) do
	ManageHighlight(player)
end

_G.DynamicAddedConn = Players.PlayerAdded:Connect(ManageHighlight)

_G.DynamicESPLoop = RunService.RenderStepped:Connect(function()
	if not _G.DynamicESP_Active then
		if _G.DynamicESPLoop then
			_G.DynamicESPLoop:Disconnect()
			_G.DynamicESPLoop = nil
		end
		return
	end

	for _, player in pairs(Players:GetPlayers()) do
		if player:GetAttribute("Role") == "Survivor" and player.Character then
			local highlight = player.Character:FindFirstChild("DynamicSurvivorHighlight")
			if not highlight then
				ManageHighlight(player)
			else
				local color = GetESPColor()
				if highlight.FillColor ~= color then
					highlight.FillColor = color
					highlight.OutlineColor = color
				end
			end
		end
	end
end)