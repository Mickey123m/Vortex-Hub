-- ESP GENERATORS (Toggle Mode) - Ultra Persistente (Auto-Reconect)
local gamePlayers = game:GetService("Players")

-- Controle de Toggle
if _G.ESP_Generators_Enabled then
    _G.ESP_Generators_Enabled = false
    warn("ESP Generators: DESATIVADO")
    
    -- Limpeza total ao desativar
    local mapFolder = workspace:FindFirstChild("Map")
    local ingame = mapFolder and mapFolder:FindFirstChild("Ingame")
    local mapModel = ingame and ingame:FindFirstChild("Map")
    
    if mapModel then
        for _, obj in pairs(mapModel:GetDescendants()) do
            if obj.Name == "Generator" and obj:IsA("Model") then
                local hl = obj:FindFirstChild("ESP_Highlight_Generator")
                if hl then hl:Destroy() end
            end
        end
    end
    return
else
    _G.ESP_Generators_Enabled = true
    warn("ESP Generators: ATIVADO")
end

-- Função para aplicar ou remover o Highlight baseado no progresso
local function updateGeneratorESP(model)
    if not _G.ESP_Generators_Enabled then return end
    if not model:IsA("Model") or model.Name ~= "Generator" then return end

    local progressValue = model:FindFirstChild("Progress")
    local highlight = model:FindFirstChild("ESP_Highlight_Generator")

    -- Se o progresso for 100, remove o ESP
    if progressValue and progressValue:IsA("NumberValue") and progressValue.Value >= 100 then
        if highlight then
            highlight:Destroy()
        end
        return
    end

    -- Cria o ESP se não existir e o progresso for < 100
    if not highlight then
        highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight_Generator"
        highlight.FillColor = Color3.fromRGB(0, 170, 255) -- Azul
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        highlight.Parent = model
        
        -- Conecta o evento de mudança de progresso apenas uma vez
        if progressValue and progressValue:IsA("NumberValue") then
            progressValue.Changed:Connect(function()
                if _G.ESP_Generators_Enabled then
                    updateGeneratorESP(model)
                end
            end)
        end
    end
    
    highlight.Adornee = model
    highlight.Enabled = true
end

-- Loop de persistência absoluta
task.spawn(function()
    while _G.ESP_Generators_Enabled do
        -- Tenta localizar o caminho do mapa a cada ciclo do loop
        local mapFolder = workspace:FindFirstChild("Map")
        local ingame = mapFolder and mapFolder:FindFirstChild("Ingame")
        local mapModel = ingame and ingame:FindFirstChild("Map")

        if mapModel then
            for _, child in pairs(mapModel:GetChildren()) do
                if child.Name == "Generator" then
                    updateGeneratorESP(child)
                end
            end
        end
        
        -- Verifica a cada 1 segundo (ideal para não pesar e não perder o mapa novo)
        task.wait(1)
    end
end)