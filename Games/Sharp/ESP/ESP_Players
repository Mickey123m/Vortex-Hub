local ESPColor = Color3.fromRGB(255, 0, 0)
local FillTransparency = 0.5
local OutlineTransparency = 0
local TeamCheck = true

if _G.ESPActiveID then
    _G.ESPActiveID = nil
    task.wait(0.1)
    for _, player in pairs(game:GetService("Players"):GetPlayers()) do
        if player.Character then
            local esp = player.Character:FindFirstChild("ExternalESP")
            if esp then esp:Destroy() end
        end
    end
    warn("ESP DETECT: DESATIVADO")
    return
end

local currentID = tick()
_G.ESPActiveID = currentID
warn("ESP DETECT: ATIVADO (AUTO-REFRESH)")

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CharactersFolder = workspace:WaitForChild("Characters")

local function applyESP(char)
    if not char:IsA("Model") then return end
    
    local hum = char:WaitForChild("Humanoid", 5)
    if not hum then return end

    local oldEsp = char:FindFirstChild("ExternalESP")
    if oldEsp then oldEsp:Destroy() end

    local plr = Players:GetPlayerFromCharacter(char)
    if char ~= LocalPlayer.Character and (not TeamCheck or (plr and plr.Team ~= LocalPlayer.Team)) then
        if hum.Health > 0 then
            local esp = Instance.new("Highlight")
            esp.Name = "ExternalESP"
            esp.Parent = char
            esp.FillColor = ESPColor
            esp.FillTransparency = FillTransparency
            esp.OutlineColor = Color3.new(1, 1, 1)
            esp.OutlineTransparency = OutlineTransparency
            esp.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
    end
end

for _, char in pairs(CharactersFolder:GetChildren()) do
    applyESP(char)
end

CharactersFolder.ChildAdded:Connect(function(char)
    if _G.ESPActiveID == currentID then
        task.wait(0.1)
        applyESP(char)
    end
end)

task.spawn(function()
    while _G.ESPActiveID == currentID do
        for _, char in pairs(CharactersFolder:GetChildren()) do
            local esp = char:FindFirstChild("ExternalESP")
            local hum = char:FindFirstChild("Humanoid")
            
            if esp then
                local plr = Players:GetPlayerFromCharacter(char)
                if (hum and hum.Health <= 0) or (TeamCheck and plr and plr.Team == LocalPlayer.Team) then
                    esp:Destroy()
                end
            elseif char ~= LocalPlayer.Character and hum and hum.Health > 0 then
                applyESP(char)
            end
        end
        task.wait(1)
    end
end)