local ESPColor = Color3.fromRGB(255, 0, 0)
local FillTransparency = 0.5
local OutlineTransparency = 0
local TeamCheck = true
local ToggleKey = "ESP_Vortex_Control_V2"

if _G[ToggleKey] then
    _G[ToggleKey] = nil
    if _G.ESPLoop then _G.ESPLoop:Disconnect() end
    
    for _, obj in pairs(game:GetDescendants()) do
        if obj:IsA("Highlight") and obj.Name == "ExternalESP" then
            obj:Destroy()
        end
    end
    
    warn("ESP DETECT: >>> DESATIVADO <<<")
    return
end

_G[ToggleKey] = true
local currentID = tick()
_G.ESPActiveID = currentID
warn("ESP DETECT: >>> ATIVADO (RECONSTRUIDO) <<<")

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

local function updateESP(player)
    if player == LocalPlayer then return end
    
    local char = player.Character
    if not char then return end

    local isEnemy = not TeamCheck or (player.Team ~= LocalPlayer.Team)
    local hum = char:FindFirstChildOfClass("Humanoid")
    local isAlive = hum and hum.Health > 0

    local esp = char:FindFirstChild("ExternalESP")

    if isEnemy and isAlive then
        if not esp then
            esp = Instance.new("Highlight")
            esp.Name = "ExternalESP"
            esp.Parent = char
        end
        
        esp.FillColor = ESPColor
        esp.FillTransparency = FillTransparency
        esp.OutlineColor = Color3.new(1, 1, 1)
        esp.OutlineTransparency = OutlineTransparency
        esp.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    else
        if esp then esp:Destroy() end
    end
end

_G.ESPLoop = RunService.RenderStepped:Connect(function()
    if _G.ESPActiveID ~= currentID then 
        _G.ESPLoop:Disconnect()
        return 
    end

    for _, plr in pairs(Players:GetPlayers()) do
        updateESP(plr)
    end
    
    local charFolder = workspace:FindFirstChild("Characters")
    if charFolder then
        for _, model in pairs(charFolder:GetChildren()) do
            local plr = Players:GetPlayerFromCharacter(model)
            if plr then
                updateESP(plr)
            end
        end
    end
end)